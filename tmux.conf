# =============================================================================
# Tmux Configuration - DevOps Edition
# =============================================================================
# Optimized for remote SSH sessions and server management
# - Session persistence (auto-save/restore)
# - Cross-platform clipboard support (macOS, Linux, WSL)
# - Minimal, performance-focused
#
# First Time Setup:
#   1. Install TPM (Tmux Plugin Manager):
#      git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
#   2. Start tmux:        tmux
#   3. Install plugins:   C-a I (capital I)
#   4. Reload config:     C-a r
#
# Quick Start:
#   1. Start tmux:        tmux
#   2. Detach:            C-a d (or C-a C-d)
#   3. Attach:            tmux attach
#   4. List sessions:     tmux ls
#   5. Kill session:      tmux kill-session -t name
#
# Common Workflow:
#   - SSH to server:      ssh user@server
#   - Start tmux:         tmux
#   - Work in tmux:       (your commands)
#   - Detach:             C-a d (session continues running)
#   - Reconnect later:    ssh user@server && tmux attach
#   - Session auto-restores on reattach
#
# Clipboard Requirements:
#   - macOS: No additional packages needed (uses pbcopy)
#   - Linux: Install xsel or xclip (apt install xsel / yum install xsel)
#   - WSL: No additional packages needed (uses clip.exe)
# =============================================================================

# =============================================================================
# Core Settings
# =============================================================================
set -g default-terminal "tmux-256color"
set -g default-shell "${SHELL}"

# Performance
set -s escape-time 0
set -g repeat-time 1000
set -g history-limit 50000
set -g status-interval 5
set -g focus-events on
set -g aggressive-resize on
set -sg buffer-limit 20

# =============================================================================
# Prefix & Mouse
# =============================================================================
# Usage:
#   Prefix key: C-a (Ctrl+a)
#   All commands start with: C-a, then the key
#   Example: C-a c = create new window
#
unbind-key C-b
set -g prefix C-a
bind-key C-a send-prefix
set -g mouse on

# =============================================================================
# Windows
# =============================================================================
# Usage:
#   C-a c        - Create new window
#   C-a p      - Previous window
#   C-a n      - Next window
#   C-a 0-9      - Switch to window number
#
set -g base-index 1
# Window status format defined in Status Bar section below

bind-key c new-window -c "#{pane_current_path}"
bind-key p previous-window
bind-key n next-window

# =============================================================================
# Panes
# =============================================================================
# Usage:
#   Split:
#     C-a |      - Split horizontally (left/right)
#     C-a -      - Split vertically (top/bottom)
#
#   Navigate:
#     C-a h      - Move to left pane
#     C-a j      - Move to bottom pane
#     C-a k      - Move to top pane
#     C-a l      - Move to right pane
#     C-a Tab    - Cycle to next pane
#
#   Resize (hold key to repeat):
#     C-a H      - Resize left
#     C-a J      - Resize down
#     C-a K      - Resize up
#     C-a L      - Resize right
#
#   Manage:
#     C-a q      - Kill current pane
#
set-window-option -g pane-base-index 1

# Split
unbind '"'
unbind %
bind-key | split-window -h -c "#{pane_current_path}"
bind-key - split-window -v -c "#{pane_current_path}"

# Navigate
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R
bind-key Tab select-pane -t :.+

# Resize
bind-key -r H resize-pane -L 10
bind-key -r J resize-pane -D 10
bind-key -r K resize-pane -U 10
bind-key -r L resize-pane -R 10

# Manage
bind-key q kill-pane

# Border
set -g pane-active-border-style fg=colour67,bg=default
set -g pane-border-style fg=colour67,bg=default
set -g pane-border-status bottom
set -g pane-border-format " #P: #{pane_current_command} PID:#{pane_pid} "


# =============================================================================
# Sessions
# =============================================================================
# Usage:
#   C-a s        - Choose/switch session (interactive)
#   C-a S        - Manually save session state
#   C-a R        - Manually restore session state
#   tmux new -s name    - Create new session from command line
#   tmux attach -t name - Attach to existing session
#   tmux ls             - List all sessions
#
# Note: Sessions auto-save every 5 minutes and auto-restore on tmux start
#
bind-key s choose-session
bind-key S run-shell '~/.tmux/plugins/tmux-resurrect/scripts/save.sh'
bind-key R run-shell '~/.tmux/plugins/tmux-resurrect/scripts/restore.sh'

# =============================================================================
# Copy Mode
# =============================================================================
# Usage:
#   C-a [        - Enter copy mode (default)
#   C-a y        - Enter copy mode (custom)
#   In copy mode:
#     v          - Start selection (vi-style)
#     y          - Copy selection to clipboard (tmux-yank handles this)
#     Esc        - Exit copy mode
#
#   Mouse:       - Drag to select, release to copy
#
# Note: tmux-yank plugin auto-detects clipboard tool
#       (macOS: pbcopy/reattach, Linux: xsel/xclip/wl-copy, WSL: clip.exe)
#       Custom keybinding (prefix+y) is set after plugin initialization below
#
set-window-option -g mode-keys vi

# Vi-style visual selection
bind-key -T copy-mode-vi v send-keys -X begin-selection

# =============================================================================
# Status Bar
# =============================================================================
# Format:
#   Left:  User@Host | Session | CPU | Memory | Time
#   Right: Window list (1 2 3 4, current highlighted, right-aligned)
#
set -g status-position bottom
set -g status-justify right
set -g status-interval 1
set -g status-left-length 150
set -g status-right-length 0
set -g status-style bg=default,fg=colour240

# Left side: User@Host | Session | CPU | Memory | Time
# Using tmux-cpu plugin for CPU and RAM display
set -g status-left ' #[fg=grey]User: #(whoami)@#h#[fg=default] | #[fg=grey]Session: #S#[fg=default] | #{cpu_fg_color}CPU: #{cpu_percentage}#[fg=default] | #{ram_fg_color}RAM: #{ram_percentage}#[fg=default] | #[fg=grey]Time: %H:%M #[fg=yellow]#{prefix_highlight}#[fg=default] '

# Right side: Window list (right-aligned)
set -g status-right ''

# Window status format (simple numbers: 1 2 3 4)
set -g window-status-format ' #[fg=grey]#I '
set -g window-status-current-format ' #[fg=yellow,bold]#I '

# Window status separator
set -g window-status-separator '#[fg=default]|'

# Window status styles (original highlight: yellow)
set-window-option -g window-status-style fg=grey,bg=default,dim
set-window-option -g window-status-current-style fg=yellow,bg=default,bright
set-window-option -g window-status-activity-style fg=colour223,bg=default

# Messages
set -g message-style bg=default,fg=grey
set -g message-command-style bg=default,fg=grey

# =============================================================================
# Configuration
# =============================================================================
# Usage:
#   C-a r        - Reload tmux configuration (apply changes without restart)
#
bind-key r source-file ~/.tmux.conf\; display-message "Config reloaded"

# =============================================================================
# Plugins
# =============================================================================
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

# Plugin Config
# tmux-yank: clipboard selection and mouse support
set -g @yank_selection 'clipboard'
set -g @yank_selection_mouse 'clipboard'
# Stay in copy mode after yanking (allows visual confirmation of selection)
set -g @yank_action 'copy-pipe'
# Disable auto-copy on mouse drag release â€” press y to copy after selecting
set -g @yank_with_mouse 'off'

# tmux-resurrect & continuum
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-save-bash-history 'on'
set -g @continuum-save-interval '5'
set -g @continuum-restore 'on'
set -g @continuum-boot 'off'

# =============================================================================
# Initialize
# =============================================================================
run '~/.tmux/plugins/tpm/tpm'

# =============================================================================
# Custom Key Bindings (After Plugin Load)
# =============================================================================
# Override tmux-yank's default prefix+y behavior
# By default, tmux-yank binds prefix+y to copy command line
# We override it to enter copy mode instead for text selection
bind-key y copy-mode
